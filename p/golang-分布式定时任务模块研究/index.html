<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Golang 分布式定时任务模块研究"><title>Golang 分布式定时任务模块研究</title>
<link rel=canonical href=https://hildam.github.io/p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/><link rel=stylesheet href=/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css><meta property="og:title" content="Golang 分布式定时任务模块研究"><meta property="og:description" content="Golang 分布式定时任务模块研究"><meta property="og:url" content="https://hildam.github.io/p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/"><meta property="og:site_name" content="HildaM"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2023-11-20T10:30:55+08:00"><meta property="article:modified_time" content="2023-11-20T10:30:55+08:00"><meta property="og:image" content="https://hildam.github.io/p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/113516139_p0.jpg"><meta name=twitter:title content="Golang 分布式定时任务模块研究"><meta name=twitter:description content="Golang 分布式定时任务模块研究"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://hildam.github.io/p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/113516139_p0.jpg"><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/2023_hu3ae23303b8bc702850a9e46930b94ec7_600573_300x0_resize_box_3.png width=300 height=329 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>HildaM</a></h1><h2 class=site-description>Software Engineer. Java, Golang.....</h2></div></header><ol class=social-menu><li><a href=https://github.com/HildaM target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><li><a href=/%E5%85%B3%E4%BA%8E%E6%88%91/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>关于我</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#1-主动轮询扫表执行>1. 主动轮询，扫表执行</a></li><li><a href=#2-存储优化--有序表>2. 存储优化 —— 有序表</a></li><li><a href=#3-存储优化--纵向分治>3. 存储优化 —— 纵向分治</a></li><li><a href=#4-存储优化横向分治>4. 存储优化：横向分治</a></li></ol><ol><li><a href=#0-自己看源码分析>0. 自己看源码分析</a></li><li><a href=#1-架构设计>1. 架构设计</a><ol><li><a href=#定时任务调度流程>定时任务调度流程</a></li></ol></li></ol><ol><li><a href=#1-每个模块依次启动>1. 每个模块依次启动</a></li><li><a href=#2-trigger-核心逻辑分析--如何书写优秀的并发逻辑>2. Trigger 核心逻辑分析 —— 如何书写优秀的并发逻辑</a><ol><li><a href=#为什么在循环-for-range-tickerc-还需要创建一个-go-func-协程这个协程做的事情与-for-range-tickerc-循环做的事情基本一致这样的设计究竟是为了什么>为什么在循环 <code>for range ticker.C</code>​ 还需要创建一个 <code>go func()</code>​ 协程。这个协程做的事情与 <code>for range ticker.C</code>​ 循环做的事情基本一致，这样的设计究竟是为了什么？</a></li><li><a href=#循环-for-range-tickerc-分析>循环 <code>for range ticker.C</code>​ 分析</a></li><li><a href=#ack-前的-select-代码块的作用gpt4>ack() 前的 select 代码块的作用（gpt4）</a></li></ol></li><li><a href=#3-golang-闭包函数在循环中的踩坑--变量拷贝问题>3. golang 闭包函数在循环中的踩坑 —— 变量拷贝问题</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/><img src=/p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/113516139_p0_hu860343e6a89ea3c01b81e7ebe66315aa_2765491_800x0_resize_q75_box.jpg srcset="/p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/113516139_p0_hu860343e6a89ea3c01b81e7ebe66315aa_2765491_800x0_resize_q75_box.jpg 800w, /p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/113516139_p0_hu860343e6a89ea3c01b81e7ebe66315aa_2765491_1600x0_resize_q75_box.jpg 1600w" width=800 height=450 loading=lazy alt="Featured image of post Golang 分布式定时任务模块研究"></a></div><div class=article-details><header class=article-category><a href=/categories/golang/>Golang
</a><a href=/categories/%E6%8A%80%E6%9C%AF/ style=background-color:#2a9d8f;color:#fff>技术</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/>Golang 分布式定时任务模块研究</a></h2><h3 class=article-subtitle>Golang 分布式定时任务模块研究</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Nov 20, 2023</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>5 minute read</time></div></footer></div></header><section class=article-content><h1 id=golang-分布式定时任务模块研究>[Golang] 分布式定时任务模块研究</h1><h1 id=学习资料>学习资料</h1><ul><li><a class=link href="https://mp.weixin.qq.com/s?__biz=MzkxMjQzMjA0OQ==&amp;amp;mid=2247483769&amp;amp;idx=1&amp;amp;sn=38d4a0c15e0e7a9f74a58e43f293e8a2&amp;amp;chksm=c10c4fa7f67bc6b1b08602e328c7ac506e4dc4c942427c730ecbfe3f18f0d1e268b1aa1e0d32&amp;amp;cur_album_id=2709593649634033668&amp;amp;scene=189#wechat_redirect" target=_blank rel=noopener>xTimer 项目代码分析文章</a></li><li><a class=link href="https://mp.weixin.qq.com/s?__biz=MzkxMjQzMjA0OQ==&amp;amp;mid=2247483771&amp;amp;idx=1&amp;amp;sn=dba806a7c991f75a60e1fe69876e6c3f&amp;amp;chksm=c10c4fa5f67bc6b3fa89fdc5aeab7121245c52410171782b25430ded202f2dea3081cd547e09&amp;amp;mpshare=1&amp;amp;scene=1&amp;amp;srcid=11097sOTubzkkcEgCrs3hfbV&amp;amp;sharer_shareinfo=76489323780177338e51560e62f79851&amp;amp;sharer_shareinfo_first=76489323780177338e51560e62f79851#rd" target=_blank rel=noopener>golang 协程池文章</a></li></ul><p>‍</p><h1 id=术语表>术语表</h1><div class=table-wrapper><table><thead><tr><th><strong>术语</strong></th><th><strong>英文名</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td>分布式定时器服务</td><td>workflow.timer</td><td>前团队在工作实践中建设的定时器基础组件</td></tr><tr><td>定时器</td><td>timer</td><td>包含一组定时任务的定义的存储介质. 和定时任务是一对多关系，定时任务按照定时器的定义定时执行. 可以类比为一个闹钟</td></tr><tr><td>定时任务</td><td>timer task</td><td>定时器的一次执行实例，可以类比为闹钟提供的一次唤醒服务.</td></tr><tr><td>时间分片</td><td>time slice</td><td>基于一定长度将时间线切割为一系列分片，各定时任务基于执行时间从属于不同时间分片.</td></tr><tr><td>二维分片</td><td>time_bucket slice</td><td>在时间分片基础上，增加分桶维度，将每个时间范围内的定时任务尽可能均衡地划分到一系列二维分片中.</td></tr><tr><td>调取器模块</td><td>scheduler module</td><td>分布式定时器服务三大模块之一，负责在全局统筹分配定时任务集合.</td></tr><tr><td>调度器协程</td><td>scheduler goroutine</td><td>调度器模块中的并发执行单位，一个模块会根据配置开启多个协程并发工作.</td></tr><tr><td>触发器模块</td><td>trigger module</td><td>分布式定时器服务三大模块之一，负责主动轮询唤起达到执行条件的定时器.</td></tr><tr><td>触发器协程</td><td>trigger goroutine</td><td>触发器模块中的并发执行单位，一个模块会根据配置开启多个协程并发工作.</td></tr><tr><td>执行器模块</td><td>executor module</td><td>分布式定时器服务三大模块之一，负责执行定时任务.</td></tr><tr><td>执行器协程</td><td>executor goroutine</td><td>执行器模块中的并发执行单位，一个模块会根据配置开启多个协程并发工作.</td></tr><tr><td>迁移器模块</td><td>migrator module</td><td>负责将热点定时任务数据沿 关系型数据库-> 缓存组件 -> 节点内存 这一顺序进行迁移的模块.（目前还未实现）</td></tr><tr><td>一级时间步</td><td>time step1</td><td>迁移器批量将定时器任务从关系型数据库迁移到缓存组件的时间间隔.</td></tr><tr><td>二级时间步</td><td>time step2</td><td>迁移器批量将定时器任务从缓存组件迁移到节点内存的时间间隔.</td></tr></tbody></table></div><p>‍</p><p>‍</p><hr><h1 id=定时任务实现思路>定时任务实现思路</h1><h2 id=1-主动轮询扫表执行>1. 主动轮询，扫表执行</h2><p>抛开“分布式定时任务”这些高大上的名词，从最原始的需求出发，我们就是希望“任务”能够在“指定时间”执行。所以最简单的方法就是将任务执行的时间记录在一张表上，等到了指定时间后开始执行。</p><p>‍</p><p>于是乎，定时器需要 2 个核心模块：轮询器 + 触发器</p><ul><li>注册<strong>定时器</strong>：解析并将一系列<strong>定时任务</strong>平铺直叙地展开，每笔定时任务明确展示<strong>执行时间</strong>这一指标</li><li>节点自<strong>轮询</strong>：每间隔一个微小的时间范围，对定时任务列表进行<strong>全量查询</strong></li><li><strong>过滤&触发</strong>：以 <strong>执行时间小于等于当前时刻</strong> 作为过滤条件，摘出满足执行条件的定时任务进行执行.</li></ul><p>​<img src=/p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/assets/image-20231109153636-hra165h.png width=1080 height=615 srcset="/p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/assets/image-20231109153636-hra165h_hud61fca5fa67ee78474dc79d6013893ac_427215_480x0_resize_box_3.png 480w, /p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/assets/image-20231109153636-hra165h_hud61fca5fa67ee78474dc79d6013893ac_427215_1024x0_resize_box_3.png 1024w" loading=lazy alt=image class=gallery-image data-flex-grow=175 data-flex-basis=421px>​</p><p>‍</p><p>这样就能满足“定时任务”的最基本需求。</p><p>不过这个丐版的实现，每次执行需要耗费 O(N) 的时间复杂度，所以说它随着任务量的增加效率会逐渐降低。</p><p>‍</p><h2 id=2-存储优化--有序表>2. 存储优化 —— 有序表</h2><p>上述的记录采用最基本的 MySQL 存储，这让每次查询的时间复杂度为 O(N)。查询的代价随着 N 记录数的增加而增加。</p><p><strong>我们可以通过将时间复杂度“平摊”到每一次查询中，比如说将存储结构更换为“红黑树”、“跳表”。</strong></p><ul><li>将插入记录的时间复杂度由 O(1) ->O(logN)为代价，换取<strong>查询时间复杂度</strong>由<strong>O(N) -> O(logN)</strong> 的优化.</li></ul><p>‍</p><p>具体来说可以使用 Redis ZSet 进行存储，以定时任务<strong>执行时间</strong>为 <strong>Score</strong> 进行有序结构的搭建，当定时任务数量达到一定量级时，ZSet 底层基于跳表作为有序表的实现. 一些更细致的实现流程如下</p><ul><li>以 Redis ZSet 作为存储介质；</li><li>每次添加定时任务时，执行 <strong>ZAdd</strong> 动作，以执行时间的时间戳作为排序的键(Score) 进行有序结构的搭建；</li><li>每次查询定时任务时，执行 <strong>ZRangeByScore</strong> 动作，以当前时刻的时间戳加上一个微小偏移量作 score 的左右边界.</li></ul><p>​<img src=/p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/assets/image-20231109154103-otnnu1s.png width=1080 height=426 srcset="/p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/assets/image-20231109154103-otnnu1s_hu84993af20ad6b26c23c715cf4a3428e5_146980_480x0_resize_box_3.png 480w, /p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/assets/image-20231109154103-otnnu1s_hu84993af20ad6b26c23c715cf4a3428e5_146980_1024x0_resize_box_3.png 1024w" loading=lazy alt=image class=gallery-image data-flex-grow=253 data-flex-basis=608px>​</p><p>‍</p><h2 id=3-存储优化--纵向分治>3. 存储优化 —— 纵向分治</h2><p>上述的优化是在查询时间上面，而查询的范围是“整个”表格。</p><p>但其实，我们只需要关注“即将执行”的任务，对于那些“更晚执行”的任务，其实是当前任务的干扰项，我们需要想办法“跳过”这些数据。</p><p>‍</p><p>我们可以对“时间”进行分片，先查询“接近即将执行”数据片段，这样就可以保证高效率。例如：</p><ul><li>插入每笔定时任务时，根据执行时间推算出所属的分钟级时间范围表达式，例如：2022-09-17-11:00:03 -> 2022-09-17-11:00:00_2022-09-17-11:01:00</li><li>以分钟级时间范围表达式为 key，将定时任务任务插入到不同 ZSet 中，组成一系列相互隔离的有序表结构.</li><li>每一次查询过程中，同样根据当前时刻推算出对应分钟级时间范围表达式，并以此为 key 查找到对应的有序表进行 ZRange 查询.</li></ul><p>​<img src=/p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/assets/image-20231109154526-m4245te.png width=1080 height=369 srcset="/p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/assets/image-20231109154526-m4245te_hudddbe8623ff324cecaff7010a0743426_103243_480x0_resize_box_3.png 480w, /p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/assets/image-20231109154526-m4245te_hudddbe8623ff324cecaff7010a0743426_103243_1024x0_resize_box_3.png 1024w" loading=lazy alt=image class=gallery-image data-flex-grow=292 data-flex-basis=702px>​</p><p>‍</p><p>每一次执行的任务量从 N 下降到 N&rsquo;（N&rsquo; &#171; N)，大大提升每次执行的效率。</p><p>‍</p><p>‍</p><h2 id=4-存储优化横向分治>4. 存储优化：横向分治</h2><p>截止目前，我们都是站在“单核”的视角优化。对于生产环境下“分布式”的需求，我们还需要考虑如何在“集群”、“多核”层面优化。而且，golang 单个节点，也需要使用 goroutine 实现高并发。</p><p>‍</p><p>因为执行任务本身是一件 CPU 密集型任务，所以需要避免因为多协程介入导致出现“锁争抢”的问题。所以，在分片上需要做到资源的最小需求，每一个分片对应的任务集都应该只由一个 goroutine 负责轮询。</p><p>因此相应的要求是，<strong>需要将时间分片拆解为更细的粒度，即在横向上额外增加一个分桶的维度，从而保证每个时间范围内能有对应于分桶数量的goroutine并发参加工作.</strong></p><p>‍</p><p>流程优化：</p><ol><li>插入定时任务时，首先根据执行时间，确定其从属的时间范围；</li><li>其次，根据定时任务的唯一标识 id，结合服务对最大桶数的设置参数，随机将定时任务划分到一个桶中；</li><li>以时间范围和桶号组装形成一个新的 key，形成一个二维分片，实现对定时任务有序表的隔离；</li><li>后续步骤与 第三小节 一致</li></ol><p>​<img src=/p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/assets/image-20231109155204-yewpnms.png width=1080 height=367 srcset="/p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/assets/image-20231109155204-yewpnms_hu3cc43b08a18566b61b5107364f7676a5_108082_480x0_resize_box_3.png 480w, /p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/assets/image-20231109155204-yewpnms_hu3cc43b08a18566b61b5107364f7676a5_108082_1024x0_resize_box_3.png 1024w" loading=lazy alt=image class=gallery-image data-flex-grow=294 data-flex-basis=706px>​</p><p>‍</p><p>‍</p><hr><h1 id=xtimer-架构分析>xTimer 架构分析</h1><p>作者开源项目地址：<a class=link href=https://github.com/xiaoxuxiansheng/xtimer target=_blank rel=noopener>github.com/xiaoxuxianshe&mldr;</a></p><p>‍</p><h2 id=0-自己看源码分析>0. 自己看源码分析</h2><p>画出了一个大致的草图，分析了 Scheduler、Trigger、Executer 三者的关联：</p><p>​<img src=/p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/assets/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20231110160900-20231110160914-a3pwqix.jpg width=2622 height=1280 srcset="/p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/assets/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20231110160900-20231110160914-a3pwqix_huc4be4793f0d82c295ba1f202540062b3_526933_480x0_resize_q75_box.jpg 480w, /p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/assets/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20231110160900-20231110160914-a3pwqix_huc4be4793f0d82c295ba1f202540062b3_526933_1024x0_resize_q75_box.jpg 1024w" loading=lazy alt=微信图片_20231110160900 class=gallery-image data-flex-grow=204 data-flex-basis=491px></p><p>这三个模块是 xTimer 的核心，其余的组件（webserver、Logger、migrator）都是基于它们的关系进行处理的。</p><p>‍</p><p>三个模块通过 Ants 协程池相互关联，达到协调工作的效果。</p><p>‍</p><h2 id=1-架构设计>1. 架构设计</h2><h3 id=定时任务调度流程>定时任务调度流程</h3><p>根据上面的分析，定时任务模块至少包含“调度器”、“触发器”、“执行器”。</p><p>而由于我们是单机任务，3 个模块都在同一个机器里面，所以我们可以利用 golang 的协程串联 3 个模块。使用“协程池”可以进一步优化协程的利用效率。</p><p>​<img src=/p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/assets/image-20231109160017-6mw42d7.png width=1080 height=516 srcset="/p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/assets/image-20231109160017-6mw42d7_hu3feb121e32c60c185896a118ff493c0c_347576_480x0_resize_box_3.png 480w, /p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/assets/image-20231109160017-6mw42d7_hu3feb121e32c60c185896a118ff493c0c_347576_1024x0_resize_box_3.png 1024w" loading=lazy alt=image class=gallery-image data-flex-grow=209 data-flex-basis=502px>​</p><ul><li><strong>3 个模块 + 2 个协程池</strong></li></ul><p>‍</p><p>‍</p><p>‍</p><hr><h1 id=优秀代码设计>优秀代码设计</h1><blockquote><p>以下对项目中某些代码片段进行着重分析，重点学习作者的设计思路</p></blockquote><h2 id=1-每个模块依次启动>1. 每个模块依次启动</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>w</span> <span class=o>*</span><span class=nx>Worker</span><span class=p>)</span> <span class=nf>Start</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>w</span><span class=p>.</span><span class=nx>trigger</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>ticker</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>NewTicker</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>w</span><span class=p>.</span><span class=nx>appConfProvider</span><span class=p>.</span><span class=nf>Get</span><span class=p>().</span><span class=nx>TryLockGapMilliSeconds</span><span class=p>)</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>ticker</span><span class=p>.</span><span class=nf>Stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=k>range</span> <span class=nx>ticker</span><span class=p>.</span><span class=nx>C</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span>
</span></span><span class=line><span class=cl>			<span class=nx>log</span><span class=p>.</span><span class=nf>WarnContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=s>&#34;stopped&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>w</span><span class=p>.</span><span class=nf>handleSlices</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这是在 Scheduler 模块的 Start 方法，它随后调用 Trigger 的 Start：</p><ul><li>w.trigger.Start(ctx)</li></ul><p>‍</p><p>Trigger 之后，也调用 Executor 的 Start 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>w</span> <span class=o>*</span><span class=nx>Worker</span><span class=p>)</span> <span class=nf>Start</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>w</span><span class=p>.</span><span class=nx>executor</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>‍</p><p>然后 Executor 的 Start 方法调用 <code>TimerService</code>​ 的 Start 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>w</span> <span class=o>*</span><span class=nx>Worker</span><span class=p>)</span> <span class=nf>Start</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>w</span><span class=p>.</span><span class=nx>timerService</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>‍</p><p>由上，我们再结合之前的架构图：</p><blockquote><p>​<img src=/p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/assets/image-20231109160017-6mw42d7.png width=1080 height=516 srcset="/p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/assets/image-20231109160017-6mw42d7_hu3feb121e32c60c185896a118ff493c0c_347576_480x0_resize_box_3.png 480w, /p/golang-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%A0%94%E7%A9%B6/assets/image-20231109160017-6mw42d7_hu3feb121e32c60c185896a118ff493c0c_347576_1024x0_resize_box_3.png 1024w" loading=lazy alt=image class=gallery-image data-flex-grow=209 data-flex-basis=502px>​</p></blockquote><p>‍</p><p>便可梳理出整体的模块调用链：<code>Scheduler -> Trigger -> Executor -> TimeService</code>​</p><p>这同时也进一步体现在每个 Struct 结构体的设计上：</p><ul><li><p>Scheduler 包含着 Trigger</p><ul><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Worker</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>pool</span>            <span class=nx>pool</span><span class=p>.</span><span class=nx>WorkerPool</span>
</span></span><span class=line><span class=cl>	<span class=nx>appConfProvider</span> <span class=nx>appConfProvider</span>
</span></span><span class=line><span class=cl>	<span class=nx>trigger</span>         <span class=o>*</span><span class=nx>trigger</span><span class=p>.</span><span class=nx>Worker</span>
</span></span><span class=line><span class=cl>	<span class=nx>lockService</span>     <span class=nx>lockService</span>
</span></span><span class=line><span class=cl>	<span class=nx>bucketGetter</span>    <span class=nx>bucketGetter</span>
</span></span><span class=line><span class=cl>	<span class=nx>minuteBuckets</span>   <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ul></li><li><p>Trigger 包含着 Executor</p><ul><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Worker</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>task</span>         <span class=nx>taskService</span>
</span></span><span class=line><span class=cl>	<span class=nx>confProvider</span> <span class=nx>confProvider</span>
</span></span><span class=line><span class=cl>	<span class=nx>pool</span>         <span class=nx>pool</span><span class=p>.</span><span class=nx>WorkerPool</span>
</span></span><span class=line><span class=cl>	<span class=nx>executor</span>     <span class=o>*</span><span class=nx>executor</span><span class=p>.</span><span class=nx>Worker</span>
</span></span><span class=line><span class=cl>	<span class=nx>lockService</span>  <span class=o>*</span><span class=nx>redis</span><span class=p>.</span><span class=nx>Client</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ul></li><li><p>Executor 包含着 TimeService</p><ul><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Worker</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>timerService</span> <span class=o>*</span><span class=nx>TimerService</span>
</span></span><span class=line><span class=cl>	<span class=nx>taskDAO</span>      <span class=o>*</span><span class=nx>taskdao</span><span class=p>.</span><span class=nx>TaskDAO</span>
</span></span><span class=line><span class=cl>	<span class=nx>httpClient</span>   <span class=o>*</span><span class=nx>xhttp</span><span class=p>.</span><span class=nx>JSONClient</span>
</span></span><span class=line><span class=cl>	<span class=nx>bloomFilter</span>  <span class=o>*</span><span class=nx>bloom</span><span class=p>.</span><span class=nx>Filter</span>
</span></span><span class=line><span class=cl>	<span class=nx>reporter</span>     <span class=o>*</span><span class=nx>promethus</span><span class=p>.</span><span class=nx>Reporter</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ul></li></ul><p>‍</p><p>‍</p><h2 id=2-trigger-核心逻辑分析--如何书写优秀的并发逻辑>2. Trigger 核心逻辑分析 —— 如何书写优秀的并发逻辑</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>w</span> <span class=o>*</span><span class=nx>Worker</span><span class=p>)</span> <span class=nf>Work</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>minuteBucketKey</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>ack</span> <span class=kd>func</span><span class=p>())</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// log.InfoContextf(ctx, &#34;trigger_1 start: %v&#34;, time.Now())
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// defer func() {
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 	log.InfoContextf(ctx, &#34;trigger_1 end: %v&#34;, time.Now())
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// }()
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// 进行为时一分钟的 zrange 处理
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>startTime</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>getStartMinute</span><span class=p>(</span><span class=nx>minuteBucketKey</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>conf</span> <span class=o>:=</span> <span class=nx>w</span><span class=p>.</span><span class=nx>confProvider</span><span class=p>.</span><span class=nf>Get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>ticker</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>NewTicker</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>conf</span><span class=p>.</span><span class=nx>ZRangeGapSeconds</span><span class=p>)</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>ticker</span><span class=p>.</span><span class=nf>Stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>endTime</span> <span class=o>:=</span> <span class=nx>startTime</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Minute</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>notifier</span> <span class=o>:=</span> <span class=nx>concurrency</span><span class=p>.</span><span class=nf>NewSafeChan</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Minute</span><span class=o>/</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>conf</span><span class=p>.</span><span class=nx>ZRangeGapSeconds</span><span class=p>)</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>))</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>notifier</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>wg</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span>
</span></span><span class=line><span class=cl>	<span class=nx>wg</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// log.InfoContextf(ctx, &#34;trigger_2 start: %v&#34;, time.Now())
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// defer func() {
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// 	log.InfoContextf(ctx, &#34;trigger_2 end: %v&#34;, time.Now())
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// }()
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>defer</span> <span class=nx>wg</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>w</span><span class=p>.</span><span class=nf>handleBatch</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>minuteBucketKey</span><span class=p>,</span> <span class=nx>startTime</span><span class=p>,</span> <span class=nx>startTime</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>conf</span><span class=p>.</span><span class=nx>ZRangeGapSeconds</span><span class=p>)</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>));</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>notifier</span><span class=p>.</span><span class=nf>Put</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=k>range</span> <span class=nx>ticker</span><span class=p>.</span><span class=nx>C</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>e</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>notifier</span><span class=p>.</span><span class=nf>GetChan</span><span class=p>():</span>
</span></span><span class=line><span class=cl>			<span class=nx>err</span><span class=p>,</span> <span class=nx>_</span> <span class=p>=</span> <span class=nx>e</span><span class=p>.(</span><span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>startTime</span> <span class=p>=</span> <span class=nx>startTime</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>conf</span><span class=p>.</span><span class=nx>ZRangeGapSeconds</span><span class=p>)</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>);</span> <span class=nx>startTime</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>endTime</span><span class=p>)</span> <span class=o>||</span> <span class=nx>startTime</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>endTime</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// log.InfoContextf(ctx, &#34;start time: %v&#34;, startTime)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>		<span class=nx>wg</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=nx>startTime</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// log.InfoContextf(ctx, &#34;trigger_2 start: %v&#34;, time.Now())
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// defer func() {
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// 	log.InfoContextf(ctx, &#34;trigger_2 end: %v&#34;, time.Now())
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// }()
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>defer</span> <span class=nx>wg</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>w</span><span class=p>.</span><span class=nf>handleBatch</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>minuteBucketKey</span><span class=p>,</span> <span class=nx>startTime</span><span class=p>,</span> <span class=nx>startTime</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>conf</span><span class=p>.</span><span class=nx>ZRangeGapSeconds</span><span class=p>)</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>));</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>notifier</span><span class=p>.</span><span class=nf>Put</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}(</span><span class=nx>startTime</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>wg</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>e</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>notifier</span><span class=p>.</span><span class=nf>GetChan</span><span class=p>():</span>
</span></span><span class=line><span class=cl>		<span class=nx>err</span><span class=p>,</span> <span class=nx>_</span> <span class=p>=</span> <span class=nx>e</span><span class=p>.(</span><span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>ack</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>InfoContextf</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=s>&#34;ack success, key: %s&#34;</span><span class=p>,</span> <span class=nx>minuteBucketKey</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>‍</p><h3 id=为什么在循环-for-range-tickerc-还需要创建一个-go-func-协程这个协程做的事情与-for-range-tickerc-循环做的事情基本一致这样的设计究竟是为了什么>为什么在循环 <code>for range ticker.C</code>​ 还需要创建一个 <code>go func()</code>​ 协程。这个协程做的事情与 <code>for range ticker.C</code>​ 循环做的事情基本一致，这样的设计究竟是为了什么？</h3><p>为了确保调用函数后，go 协程的逻辑会立即得到执行。</p><p>​<code>for range ticker.C</code>​ 循环中的逻辑，并不会在调用 trigger.Work 后会立即执行。</p><p>‍</p><h3 id=循环-for-range-tickerc-分析>循环 <code>for range ticker.C</code>​ 分析</h3><p>每一个 for range 循环都创建一个 协程，执行批量处理的操作。每一次循环都有一个 select 监控管道，确保任何一个协程出现错误后，立即返回错误。</p><p>同时，这个 select 会监听 2 个 channel 的信息：ticker 和 业务协程</p><p><code>for range ticker.C</code>​ 循环确实会在每次迭代时阻塞，直到 <code>ticker</code>​ 通道接收到下一个时间点的信号。这是定时器 <code>time.Ticker</code>​ 的典型用法，用于在固定的时间间隔触发操作。具体来说：</p><ol><li><p><strong>定时器的作用</strong>：</p><ul><li>​<code>ticker := time.NewTicker(time.Duration(conf.ZRangeGapSeconds) * time.Second)</code>​ 创建了一个定时器 <code>ticker</code>​，它会在设定的间隔（<code>conf.ZRangeGapSeconds</code>​ 秒）后向其通道 <code>ticker.C</code>​ 发送时间信号。</li><li>每次 <code>ticker.C</code>​ 接收到信号时，<code>for range ticker.C</code>​ 循环就会进行下一次迭代。</li></ul></li><li><p><strong>阻塞行为</strong>：</p><ul><li>在 <code>for range ticker.C</code>​ 循环中，每次迭代都会等待直到 <code>ticker.C</code>​ 通道接收到下一个时间点的信号。这意味着循环的每次迭代之间会有一个固定的时间间隔，这个间隔由 <code>ticker</code>​ 的设置决定。</li><li>在等待 <code>ticker.C</code>​ 通道的过程中，确实会发生阻塞。但这是有意为之的，以确保按照预定的时间间隔执行操作。</li></ul></li><li><p>​**<code>select</code><strong>​ ** 语句的作用</strong>：</p><ul><li>在循环内部的 <code>select</code>​ 语句块用于检查是否有来自 <code>notifier.GetChan()</code>​ 的错误信号。这是一个非阻塞的检查，因为包含了 <code>default</code>​ 分支。</li><li>如果 <code>notifier</code>​ 通道中有错误，它会立即被处理并返回。如果没有错误，<code>default</code>​ 分支会执行，循环继续到下一次迭代。</li></ul></li></ol><p>‍</p><p>同时 ticket.C 只要不显式停止，它就会一直执行下去。在 for 函数内，只要执行时间达到 endTime 的时候，就会被停止，跳出循环！</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>startTime</span> <span class=p>=</span> <span class=nx>startTime</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>conf</span><span class=p>.</span><span class=nx>ZRangeGapSeconds</span><span class=p>)</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>);</span> <span class=nx>startTime</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>endTime</span><span class=p>)</span> <span class=o>||</span> <span class=nx>startTime</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>endTime</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>执行时间间隔为一分钟</li></ul><p>‍</p><h3 id=ack-前的-select-代码块的作用gpt4>ack() 前的 select 代码块的作用（gpt4）</h3><p>代码最后的 <code>select</code>​ 语句块起着关键作用，特别是在处理并发操作和错误管理方面。具体来说：</p><ol><li><p><strong>错误处理</strong>：</p><ul><li>这个 <code>select</code>​ 语句块用于检查 <code>notifier.GetChan()</code>​ 通道，以判断是否有来自并发执行的协程的错误。</li><li>如果某个协程在执行 <code>w.handleBatch</code>​ 函数时遇到错误并通过 <code>notifier.Put(err)</code>​ 发送了一个错误，那么这个错误会被放入 <code>notifier</code>​ 的通道中。</li><li>当 <code>select</code>​ 语句块执行时，它会从 <code>notifier.GetChan()</code>​ 通道中接收错误。如果通道中有错误，那么这个错误会被赋值给 <code>err</code>​ 变量，并由函数返回，从而传播错误。</li></ul></li><li><p><strong>确保所有协程完成</strong>：</p><ul><li>在这之前的 <code>wg.Wait()</code>​ 调用确保了在继续之前，所有由 <code>Work</code>​ 函数启动的协程都已经完成了它们的工作。</li><li>在所有协程完成之后，再次检查 <code>notifier</code>​ 通道是为了确保在协程执行过程中产生的任何错误都被捕获和处理。</li></ul></li><li><p><strong>非阻塞检查</strong>：</p><ul><li>使用 <code>select</code>​ 的 <code>default</code>​ 分支确保了这个错误检查是非阻塞的。如果 <code>notifier</code>​ 通道中没有错误，代码就会执行 <code>default</code>​ 分支，这避免了函数在此处无限期地等待。</li></ul></li><li><p><strong>干净的退出</strong>：</p><ul><li>如果所有协程都成功执行并且没有错误，那么这个 <code>select</code>​ 语句就不会捕获任何错误，函数将继续执行 <code>ack()</code>​ 调用和后续的日志记录，然后正常返回。</li></ul></li></ol><p>‍</p><p>‍</p><h2 id=3-golang-闭包函数在循环中的踩坑--变量拷贝问题>3. golang 闭包函数在循环中的踩坑 —— 变量拷贝问题</h2><p>在Go语言中，闭包（即函数内定义的匿名函数）会捕获其外部函数的变量。当这些闭包在并发环境（如多个协程）中执行时，就可能出现并发问题，尤其是当这些闭包共享对外部变量的访问时。</p><p>在之前的代码示例中，有一段这样的代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>task</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>tasks</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>task</span> <span class=o>:=</span> <span class=nx>task</span> <span class=c1>// 重要的局部变量复制
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>w</span><span class=p>.</span><span class=nx>pool</span><span class=p>.</span><span class=nf>Submit</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ... 使用 task
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>});</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里的关键点在于<code>task := task</code>​这行代码。它的作用及其重要性：</p><ol><li><strong>闭包和外部变量</strong>：在for循环中，匿名函数（即闭包）是通过<code>w.pool.Submit</code>​提交并可能在不同的协程上执行的。这个闭包引用了循环变量<code>task</code>​。</li><li><strong>变量捕获的工作原理</strong>：<strong>闭包不会为它引用的每次迭代创建</strong><code>**task**</code><strong>的独立副本。相反，所有迭代共享同一个</strong><code>**task**</code><strong>变量。这意味着闭包内部对</strong><code>**task**</code><strong>的引用在迭代时会改变。</strong></li><li><strong>并发问题的产生</strong>：如果没有局部变量复制，所有的闭包将引用相同的<code>task</code>​变量。由于这些闭包可能在不同的协程中并发执行，因此当<code>task</code>​在循环的下一次迭代中更新时，已经在执行中的闭包看到的<code>task</code>​值也会改变。<strong>这会导致所有闭包最终可能都使用最后一次迭代的</strong><code>**task**</code><strong>值，而不是它们各自迭代时的值。</strong></li><li><strong>局部变量复制的作用</strong>：通过<code>task := task</code>​，每次迭代都会创建<code>task</code>​的一个新副本。这样，每个闭包都捕获了这个副本而不是共享的循环变量。因此，即使外部循环继续进行并更新<code>task</code>​变量，每个闭包中捕获的副本值都不会改变。</li><li><strong>不这么做的后果</strong>：如果不进行局部变量复制，所有并发执行的闭包可能都会错误地使用相同的（最后一次迭代的）<code>task</code>​值，导致数据不一致、错误的行为或其他难以追踪的并发相关的bug。</li></ol><p>‍</p><p>简而言之，<code>task := task</code>​这种做法是确保闭包在并发执行时能安全使用迭代变量的一种重要且有效的技术。它避免了并发执行时由于变量共享导致的潜在问题，是Go语言并发编程中的一个常见且重要的模式。</p><p>‍</p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/golang-%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/><div class=article-image><img src=/p/golang-%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/F-GFw9_bQAAbpnT.807db15e48e6da9ecb8bc635900b73d7_hu8b370bc56ba849f07817004841874d66_136981_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post golang 依赖注入" data-key="golang 依赖注入" data-hash="md5-gH2xXkjm2p7Li8Y1kAtz1w=="></div><div class=article-details><h2 class=article-title>golang 依赖注入</h2></div></a></article><article class=has-image><a href=/p/fuction_calling-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/><div class=article-image><img src=/p/fuction_calling-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/1699747644613.5cd4ccb8882827b5a7dc85518534dd9d_huadb2298c974893890e316b9292267589_1494364_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post Fuction_Calling 快速入门" data-key="Fuction_Calling 快速入门" data-hash="md5-XNTMuIgoJ7Wn3IVRhTTdnQ=="></div><div class=article-details><h2 class=article-title>Fuction_Calling 快速入门</h2></div></a></article><article class=has-image><a href=/p/%E7%BB%9F%E4%B8%80%E7%AE%A1%E7%90%86%E9%A1%B9%E7%9B%AE%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%B1%A0/><div class=article-image><img src=/p/%E7%BB%9F%E4%B8%80%E7%AE%A1%E7%90%86%E9%A1%B9%E7%9B%AE%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%B1%A0/FTwneuGaAAEIwOy.8e2a6ddf6ec18fca5a630c1cc8ae211a_hu3cd8c2a946427a90a45d3467884b8180_568116_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post 统一管理项目的线程池" data-key=统一管理项目的线程池 data-hash="md5-jipt327Bj8paYwwcyK4hGg=="></div><div class=article-details><h2 class=article-title>统一管理项目的线程池</h2></div></a></article><article class=has-image><a href=/p/redis-lua-%E8%84%9A%E6%9C%AC%E5%AE%9E%E7%8E%B0%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%88%86%E6%89%B9%E6%93%8D%E4%BD%9C/><div class=article-image><img src=/p/redis-lua-%E8%84%9A%E6%9C%AC%E5%AE%9E%E7%8E%B0%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%88%86%E6%89%B9%E6%93%8D%E4%BD%9C/83565371_p0.a1df237a93ba3353d3c0d987520cc218_hua456e595fa8251e7d0c86f0f4b777cf0_328426_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post Redis Lua 脚本实现大数据分批操作" data-key="Redis Lua 脚本实现大数据分批操作" data-hash="md5-od8jepO6M1PTwNmHUgzCGA=="></div><div class=article-details><h2 class=article-title>Redis Lua 脚本实现大数据分批操作</h2></div></a></article><article class=has-image><a href=/p/%E4%BD%BF%E7%94%A8%E6%B3%A8%E8%A7%A3%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95%E7%9A%84%E4%BA%8B%E5%8A%A1%E6%89%A7%E8%A1%8C/><div class=article-image><img src=/p/%E4%BD%BF%E7%94%A8%E6%B3%A8%E8%A7%A3%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95%E7%9A%84%E4%BA%8B%E5%8A%A1%E6%89%A7%E8%A1%8C/112155320_p0.3e4ec0a8a34fc4e83a2b4f0a11c5a89a_hu01d92a70b7b8c10e235bacf971634f06_5629370_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post 使用注解实现方法的事务执行" data-key=使用注解实现方法的事务执行 data-hash="md5-Pk7AqKNPxOg6K08KEcWomg=="></div><div class=article-details><h2 class=article-title>使用注解实现方法的事务执行</h2></div></a></article></div></div></aside><script src=https://utteranc.es/client.js repo=HildaM/hilda-blog-comment issue-term=pathname crossorigin=anonymous async></script><style>.utterances{max-width:unset}</style><script>let utterancesLoaded=!1;function setUtterancesTheme(e){let t=document.querySelector(".utterances iframe");t&&t.contentWindow.postMessage({type:"set-theme",theme:`github-${e}`},"https://utteranc.es")}addEventListener("message",e=>{if(e.origin!=="https://utteranc.es")return;utterancesLoaded=!0,setUtterancesTheme(document.documentElement.dataset.scheme)}),window.addEventListener("onColorSchemeChange",e=>{if(!utterancesLoaded)return;setUtterancesTheme(e.detail)})</script><footer class=site-footer><section class=copyright>&copy;
2023 HildaM</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.21.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>